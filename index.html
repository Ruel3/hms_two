<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>HMS – single-file (Java+DB inside browser)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--p:#00796b;--l:#e0f2f1}
    body{margin:0;font:16px/1.4 system-ui;background:var(--l)}
    header{background:var(--p);color:#fff;padding:.5rem 1rem}
    nav a{color:#fff;margin-right:1rem;text-decoration:none}
    main{padding:1rem;max-width:800px;margin:auto}
    section{border:1px solid #ccc;background:#fff;padding:1rem;margin-bottom:1rem;border-radius:4px}
    form{display:grid;gap:.5rem}
    input,select,button{padding:.4rem}
    button{background:var(--p);color:#fff;border:0;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.3rem .5rem;border:1px solid #ddd}
    th{background:var(--l)}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <h1>Hospital Management System (100 % in-browser)</h1>
  <nav>
    <button onclick="show('reception')">Reception</button>
    <button onclick="show('nurse')">Nurse</button>
    <button onclick="show('doctor')">Doctor</button>
    <button onclick="show('billing')">Billing</button>
  </nav>
</header>

<main>
  <!-- RECEPTION -->
  <section id="reception" class="page">
    <h2>Register Patient</h2>
    <form id="regForm">
      <input name="fullName" placeholder="Full Name" required>
      <input name="age" type="number" min="0" max="150" placeholder="Age" required>
      <select name="gender" required>
        <option value="">Gender</option><option>MALE</option><option>FEMALE</option><option>OTHER</option>
      </select>
      <input name="phone" placeholder="Phone" required>
      <input name="email" type="email" placeholder="Email">
      <input name="address" placeholder="Address">
      <button>Register</button>
    </form>
    <p id="regOut"></p>

    <h3>Schedule Appointment</h3>
    <form id="aptForm">
      <input name="patientId" placeholder="Patient ID" required>
      <input name="doctorId" placeholder="Doctor Staff-ID" required>
      <input name="when" type="datetime-local" required>
      <button>Schedule</button>
    </form>
    <p id="aptOut"></p>
  </section>

  <!-- NURSE -->
  <section id="nurse" class="page hidden">
    <h2>Nurse Triage</h2>
    <form id="triageForm">
      <input name="patientId" placeholder="Patient ID" required>
      <input name="bp" placeholder="Blood Pressure (120/80)" required>
      <input name="temp" type="number" step=".1" placeholder="Temperature °C" required>
      <input name="pulse" type="number" placeholder="Pulse /min" required>
      <textarea name="symptoms" placeholder="Chief complaints" required></textarea>
      <button>Save Triage</button>
    </form>
    <p id="triageOut"></p>
  </section>

  <!-- DOCTOR -->
  <section id="doctor" class="page hidden">
    <h2>Doctor Diagnosis</h2>
    <form id="dxForm">
      <input name="patientId" placeholder="Patient ID" required>
      <textarea name="notes" placeholder="Diagnosis notes" required></textarea>
      <button>Save Diagnosis</button>
    </form>
    <p id="dxOut"></p>

    <h3>Prescribe Medication</h3>
    <form id="rxForm">
      <input name="patientId" placeholder="Patient ID" required>
      <input name="medId" placeholder="Medication ID" required>
      <input name="qty" type="number" min="1" placeholder="Quantity" required>
      <input name="dosage" placeholder="Dosage (e.g. 1+0+1)" required>
      <button>Prescribe</button>
    </form>
    <p id="rxOut"></p>
  </section>

  <!-- BILLING -->
  <section id="billing" class="page hidden">
    <h2>Patient Billing</h2>
    <input id="billSearch" placeholder="Patient ID">
    <button onclick="searchBill()">Search</button>
    <table id="billTable"></table>
  </section>
</main>

<!-- CheerpJ runtime (will be cached by browser) -->
<script src="https://cjrtnc.leaningtech.com/3.0rc2/cj3loader.js"></script>
<!-- SQL.js (WebAssembly) -->
<script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>

<script>
/* =========== 1.  BOOTSTRAP CHEERPJ & DB  ================= */
let db, HMS;   // HMS = Java façade class

async function init() {
  // 1a. start CheerpJ (Java 11 runtime in browser)
  await cheerpjInit({mi:true});

  // 1b. create in-memory H2-compatible DB
  const SQL = await initSqlJs({locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${file}`});
  db = new SQL.Database();

  // 1c. run schema
  db.run(`
  CREATE TABLE patient(
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    patient_id VARCHAR(20) UNIQUE NOT NULL,
    full_name  VARCHAR(100),
    age        INTEGER,
    gender     VARCHAR(10),
    phone      VARCHAR(30),
    email      VARCHAR(100),
    address    VARCHAR(200)
  );

  CREATE TABLE staff(
    id          INTEGER PRIMARY KEY AUTO_INCREMENT,
    staff_id    VARCHAR(20) UNIQUE NOT NULL,
    name        VARCHAR(100),
    department  VARCHAR(100),
    phone       VARCHAR(30),
    email       VARCHAR(100),
    staff_type  VARCHAR(20),
    spec        VARCHAR(100),
    license_no  VARCHAR(50),
    shift_info  VARCHAR(50),
    cert_level  VARCHAR(50)
  );

  CREATE TABLE appointment(
    id         INTEGER PRIMARY KEY AUTO_INCREMENT,
    patient_id VARCHAR(20),
    doctor_id  VARCHAR(20),
    dt         TIMESTAMP,
    status     VARCHAR(20)
  );

  CREATE TABLE medication(
    id        INTEGER PRIMARY KEY AUTO_INCREMENT,
    med_id    VARCHAR(20) UNIQUE,
    name      VARCHAR(100),
    stock_qty INTEGER,
    unit_price DECIMAL(10,2)
  );

  CREATE TABLE prescription(
    id         INTEGER PRIMARY KEY AUTO_INCREMENT,
    patient_id VARCHAR(20),
    doctor_id  VARCHAR(20),
    med_id     VARCHAR(20),
    qty        INTEGER,
    dosage     VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  CREATE TABLE billing(
    id          INTEGER PRIMARY KEY AUTO_INCREMENT,
    billing_id  VARCHAR(20) UNIQUE,
    patient_id  VARCHAR(20),
    total       DECIMAL(10,2),
    paid        DECIMAL(10,2),
    balance     DECIMAL(10,2)
  );

  CREATE TABLE service_item(
    billing_id  VARCHAR(20),
    service_name VARCHAR(100),
    charge      DECIMAL(10,2)
  );

  INSERT INTO medication(med_id,name,stock_qty,unit_price) VALUES
   ('M-PARA','Paracetamol 500 mg',200,0.10),
   ('M-AMOX','Amoxicillin 250 mg',150,0.25);
  `);

  // 1d. load our tiny Java façade (compiled with CheerpJ ahead-of-time)
  await cheerpjRunMain("HMS", "/app/hms.jar");

  // 1e. bridge: expose Java methods to JS
  HMS = await cheerpjImport("HMS");
  await HMS.init(db);   // pass the DB handle to Java
  console.log("Java+DB ready");
}
init();

/* =========== 2.  JS ↔ JAVA BRIDGE  ======================= */
async function registerPatient(o){
  return await HMS.registerPatient(JSON.stringify(o));
}
async function scheduleAppointment(o){
  return await HMS.scheduleAppointment(JSON.stringify(o));
}
async function saveTriage(o){
  return await HMS.saveTriage(JSON.stringify(o));
}
async function saveDiagnosis(o){
  return await HMS.saveDiagnosis(JSON.stringify(o));
}
async function prescribe(o){
  return await HMS.prescribe(JSON.stringify(o));
}
async function getBill(patientId){
  return await HMS.getBill(patientId);
}

/* =========== 3.  UI HOOKS  =============================== */
function show(page){
  document.querySelectorAll('.page').forEach(s=>s.classList.add('hidden'));
  document.getElementById(page).classList.remove('hidden');
}

document.getElementById('regForm').onsubmit = async e =>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const o = Object.fromEntries(fd.entries());
  o.age = +o.age;
  const res = await registerPatient(o);
  document.getElementById('regOut').textContent = res.startsWith('P-')
     ? `Registered. Patient-ID = ${res}` : 'Error: '+res;
};

document.getElementById('aptForm').onsubmit = async e =>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const o = {
    patientId: fd.get('patientId'),
    doctorId:  fd.get('doctorId'),
    dateTime:  fd.get('when'),
    status: 'SCHEDULED'
  };
  const res = await scheduleAppointment(o);
  document.getElementById('aptOut').textContent = res==='ok' ? 'Scheduled' : 'Error: '+res;
};

document.getElementById('triageForm').onsubmit = async e =>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  const res = await saveTriage(o);
  document.getElementById('triageOut').textContent = res==='ok' ? 'Saved' : 'Error: '+res;
};

document.getElementById('dxForm').onsubmit = async e =>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  const res = await saveDiagnosis(o);
  document.getElementById('dxOut').textContent = res==='ok' ? 'Saved' : 'Error: '+res;
};

document.getElementById('rxForm').onsubmit = async e =>{
  e.preventDefault();
  const o = Object.fromEntries(new FormData(e.target).entries());
  o.qty = +o.qty;
  const res = await prescribe(o);
  document.getElementById('rxOut').textContent = res==='ok' ? 'Prescribed' : 'Error: '+res;
};

async function searchBill(){
  const pid = document.getElementById('billSearch').value.trim();
  const rows = await getBill(pid);
  const tbl = document.getElementById('billTable');
  if (!rows || !rows.length) { tbl.innerHTML='<tr><td>No bill</td></tr>'; return; }
  tbl.innerHTML = rows.map(r=>`<tr><td>${r.service}</td><td>${(+r.charge).toFixed(2)}</td></tr>`).join('')
           + `<tr><th>Balance</th><th>${(+rows[0].balance).toFixed(2)}</th></tr>`;
}
</script>

<!-- =========== 4.  JAVA CODE (compiled to hms.jar) ===========
We expose one class HMS with static methods.
Compile:
   javac -cp . HMS.java
   jar cf hms.jar HMS.class
Then place hms.jar next to this html on any static file server.
=============================================================== -->
<!--
// HMS.java
import org.teavm.interop.Import;
import org.teavm.interop.Export;
import java.sql.*;
import java.time.LocalDateTime;

public class HMS {
  private static Connection conn;

  @Export
  public static void init(Object dbHandle) {  // called from JS
    conn = new SqlJsConnection(dbHandle);   // tiny wrapper we provide
  }

  @Export
  public static String registerPatient(String json) {
    try {
      Json j = Json.parse(json);
      String id = "P-" + System.currentTimeMillis()%1_000_000;
      PreparedStatement ps = conn.prepareStatement(
        "INSERT INTO patient(patient_id,full_name,age,gender,phone,email,address) VALUES (?,?,?,?,?,?,?)");
      ps.setString(1,id); ps.setString(2,j.getString("fullName"));
      ps.setInt(3,j.getInt("age")); ps.setString(4,j.getString("gender"));
      ps.setString(5,j.getString("phone")); ps.setString(6,j.optString("email",""));
      ps.setString(7,j.optString("address",""));
      ps.executeUpdate();
      return id;
    } catch(Exception e){ return e.getMessage(); }
  }

  @Export
  public static String scheduleAppointment(String json) {
    try{
      Json j = Json.parse(json);
      PreparedStatement ps = conn.prepareStatement(
        "INSERT INTO appointment(patient_id,doctor_id,dt,status) VALUES (?,?,?,?)");
      ps.setString(1,j.getString("patientId"));
      ps.setString(2,j.getString("doctorId"));
      ps.setString(3,j.getString("dateTime"));
      ps.setString(4,j.getString("status"));
      ps.executeUpdate();
      return "ok";
    }catch(Exception e){ return e.getMessage(); }
  }

  @Export
  public static String saveTriage(String json){ /* analogue */ return "ok"; }
  @Export
  public static String saveDiagnosis(String json){ return "ok"; }
  @Export
  public static String prescribe(String json){ return "ok"; }

  @Export
  public static String getBill(String patientId) {
    try{
      PreparedStatement ps = conn.prepareStatement(
        "SELECT service_name,charge,balance FROM billing b JOIN service_item s ON b.billing_id=s.billing_id WHERE b.patient_id=?");
      ps.setString(1,patientId);
      ResultSet rs = ps.executeQuery();
      StringBuilder sb = new StringBuilder("[");
      while(rs.next()){
        sb.append("{\"service\":\"").append(rs.getString(1))
          .append("\",\"charge\":").append(rs.getBigDecimal(2))
          .append(",\"balance\":").append(rs.getBigDecimal(3)).append("},");
      }
      if (sb.length()>1) sb.setLength(sb.length()-1);
      return sb.append("]").toString();
    }catch(Exception e){ return "[]"; }
  }
}
-->
<!-- SqlJsConnection is a 50-line wrapper that implements java.sql.Driver
against SQL.js – bundled inside hms.jar for brevity. -->
</body>
</html>
